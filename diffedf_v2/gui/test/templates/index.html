<!DOCTYPE html>
<html>
<head>
    <title>Point Cloud Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- <script src="https://threejs.org/build/three.js"></script> -->
    <!-- <script src="https://unpkg.com/three@0.160.1/build/three.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <script type="importmap">
		{
			"imports": {
			"three": "https://unpkg.com/three@0.160.1/build/three.module.js",
			"three/addons/": "https://unpkg.com/three@0.160.1/examples/jsm/"
			}
		}
		</script>

    <script type="module">
        import * as THREE from 'three';
        // THREE.Object3D.DefaultUp = new THREE.Vector3(0,0,1);

        // Renderer
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.body.appendChild( renderer.domElement );
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Initialize scene, camera, and renderer
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.up.set(0,0,1);
        scene.add(camera);
        var grid = new THREE.GridHelper( 2, 20, 0x888888, 0x555555 );
        grid.rotateX(Math.PI / 2); 
        scene.add(grid);


        // import { ArcballControls } from '/static/ArcBallControls.js';
        // const controls = new ArcballControls( camera, renderer.domElement, scene ); // 
        // controls.addEventListener( 'change', function () {
        //     renderer.render( scene, camera );
        // } );

        import {OrbitControls} from '/static/OrbitControls.js';
        const controls = new OrbitControls( camera, renderer.domElement );
        // controls.maxPolarAngle = 1.570796;
        controls.screenSpacePanning = false;

        // import {MapControls} from '/static/MapControls.js';
        // const controls = new MapControls( camera, renderer.domElement );
        // controls.enableDamping = true;

        

        camera.position.set( 0, 0, 1.5 );
        controls.target = new THREE.Vector3(0., 0, 0);



        // Function to add points to the scene
        function addPoints(data) {
            var geometry = new THREE.BufferGeometry();
            var pos = new Float32Array(data.x.flat());
            geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));

            if ('f' in data && Array.isArray(data.f)) {
                var color = new Float32Array(data.f.flat());
                geometry.setAttribute('color', new THREE.BufferAttribute(color, 3));
                var material = new THREE.PointsMaterial({ vertexColors: true }); 
            } else {
                //////////////////////////////////////////////////////////////////////////////////////
                // https://threejs.org/docs/#api/en/materials/PointsMaterial.size
                //////////////////////////////////////////////////////////////////////////////////////
                var material = new THREE.PointsMaterial({ color: 0x888888 }); 
                //////////////////////////////////////////////////////////////////////////////////////
            }
            material.size = 0.003;
            


            var points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        // Render loop
        function animate() {
            requestAnimationFrame(animate);

            controls.update();
            // controls.update( clock.getDelta() );
            renderer.render(scene, camera);
        }
        animate();




        // // Fetch point cloud data from Flask backend
        // function fetchPointCloud() {
        //     $.getJSON('/getPointCloud', function(data) {
        //         addPoints(data);
        //     });
        // }

        // // Event listener for mouse click
        // document.addEventListener('click', fetchPointCloud);



        // Connect to WebSocket
        var socket = io();

        // Handle geometry update
        socket.on('update_graph', function(graph) {
            // Use data.geometry to update the scene
            addPoints(graph);
        });




    </script>
</body>
</html>
